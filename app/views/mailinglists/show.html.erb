<!-- timelines -->

<!-- ##Gmap Library <script src="/assets/timelines/maps.js"></script> <script src="/assets/timelines/timeline.js"></script> -->

<div class="content-wrap">
    <!-- main page content. the place to put widgets in. usually consists of .row > .col-md-* > .widget.  -->
    <main id="content" class="content" role="main">
        <ol class="breadcrumb" style="font-size:16px;">
            <li>Tongsu</li>
            <li class="active">Mailing List</li>
        </ol>
        <h2 class="page-title"><%= @channel.group.name %> - <span class="fw-semi-bold"><%= @channel.name %></span></h2>
        <ul class="timeline" style="">
            <% temp_date    = nil %>
            <% color_index  = 0 %>

            <% @mailinglists.each do |message| %>
            <% message_updated_at = message.updated_at.localtime.strftime("%b %e") %>
            <li >
                <% if temp_date.nil? or message_updated_at != temp_date %>
                    <% temp_date   = message_updated_at %>

                    <time class="event-time" datetime="">
                        <!-- <span class="date"><%= message_updated_at %></span> -->
                        <span class="time" style="padding-right: 100px;">
                            <% if message_updated_at == DateTime.now.strftime("%b %e") %>
                                Today
                            <% else %>
                                <%= message_updated_at %>
                            <% end %>
                        </span>
                    </time>      

                    <% case ( color_index % 6 ) %>
                    <% when 0 %>
                        <% color = "event-icon-danger" %>
                    <% when 1 %>
                        <% color = "event-icon-warning" %>
                    <% when 2 %>
                        <% color = "event-icon-success" %>
                    <% when 3 %>
                        <% color = "event-icon-info" %>
                    <% when 4 %>
                        <% color = "event-icon-primary" %>
                    <% when 5 %>
                        <% color = "event-icon-gary" %>
                    <% end %>

                    <span class="event-icon <%= color %>">
                        <i class="glyphicon glyphicon-sort"></i>
                    </span>

                    <% color_index = color_index+1 %>
                <% end %>
                <section class="event">
                    <span class="thumb-sm avatar pull-left mr-sm">
                        <img class="img-circle" src="<%= asset_path 'avatar.png' %>">
                    </span>
                    <h4 class="event-heading"><a href="#"><%= message.from_name %></a> <small><%= message.from %></small></h4>
                    <p class="fs-sm text-muted"><%= message.created_at.localtime.strftime("%b %e, %l:%M %P") %> - to <%= @channel.name %></p>
                    <h4 style="margin-bottom: 20px;"><span class="fw-semi-bold"><%= message.subject %></span></h4>
                    <div class="fs-mini" style="font-size:15px !important;font-weight: 400;">
                        <% if message.content.length > 400 %>
                            <% first_message = truncate(message.content, length: 350, omission: "<span class='text_exposed_hide'>...</span>", separator: "<br>", escape: false) { link_to "Continue", "javascript:{};", onclick: 'see_more('+ message.id.to_s+')' } %>
                            <div id="message_content_<%= message.id %>"><%= Nokogiri::HTML::DocumentFragment.parse(first_message).to_html.html_safe %></div>

                        <% else %>
                            <%= message.content.html_safe %>
                        <% end %>
                    </div>
                    <% if message.attaches.present? %>
                    <div class="email-attachments">
                        <div class="row">
                            <div class="col-sm-6">
                                <hr>
                                <p class="details"><strong><%= pluralize(message.attaches.count, "attachment") %></strong> &nbsp;
                                    <!-- S-&nbsp; <a href="#">Download all attachments</a> &nbsp;&nbsp;&nbsp;<a href="javascript:{}" onclick="" >View all Images</a></p> -->
                                <% message.attaches.each do |file| %>
                                <section class="attachment" stlye="width:300px;">
                                    <% if file.content_content_type.start_with?('image/') %>
                                        <a href="<%= file.content.url %>" data-lightbox="roadtrip" data-title="<%= file.content_file_name %>">
                                        <%= image_tag file.content.url, style: "max-width: 300px;" %></a>
                                    <% end %>
                                        <h5 class="title"><%= file.content_file_name %></h5>
                                        <p class="details">
                                            <%= (file.content_file_size/1024.0).round(2) %>K  &nbsp;&nbsp;
                                            <%= link_to "Download", api_download_url(url: file.content.path, subdomain: "api"), method: :post %>
                                        </p>
                                </section>
                                <% end %>
                            </div>
                        </div>
                    </div> 
                    <% end %>
                    <footer style="font-weight:400;" >
                        <ul class="post-links">
                            <li><a href="#">1 hour</a></li>
                            <li><a href="#"><span class="text-danger"><i class="fa fa-heart"></i> Like</span></a></li>
                            <% reply = Array.new %>
                            <% recursive(reply, message) %>
                            <li><a href="javascript:{}" onclick="get_comments(<%= message.id.to_s %>)"><%= pluralize(reply.count-1, 'Comment') %></a></li>
                        </ul>
                        <ul class="post-comments" id="message_reply_<%= message.id %>" >
                        </ul>
                    </footer>
                </section>
            </li>
            <% end %>
        </ul>
    </main>
</div>

<script src="/assets/timelines/jquery.magnific-popup.min.js"></script>
<script src="/assets/mailinglists.js"></script>